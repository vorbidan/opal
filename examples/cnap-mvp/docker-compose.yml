version: '3.8'

name: opal-sentinel-example

services:
  # Redis Sentinel Setup: 3 nodes each running Redis + Sentinel
  # Node 1: Master (initially)
  redis-sentinel-1:
    image: "redis:7-alpine"
    container_name: redis-sentinel-1
    command: >
      sh -c "
      redis-server --port 6380 --bind 0.0.0.0 --replica-announce-ip 127.0.0.1 &
      sleep 2 &&
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'bind 0.0.0.0' >> /tmp/sentinel.conf &&
      echo 'sentinel announce-ip 127.0.0.1' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster 127.0.0.1 6380 2' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "6380:6380"
      - "26379:26379"
    network_mode: "host"

  # Node 2: Replica + Sentinel
  redis-sentinel-2:
    image: "redis:7-alpine"
    container_name: redis-sentinel-2
    command: >
      sh -c "
      redis-server --port 6381 --bind 0.0.0.0 --replicaof 127.0.0.1 6380 --replica-announce-ip 127.0.0.1 &
      sleep 2 &&
      echo 'port 26380' > /tmp/sentinel.conf &&
      echo 'bind 0.0.0.0' >> /tmp/sentinel.conf &&
      echo 'sentinel announce-ip 127.0.0.1' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster 127.0.0.1 6380 2' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "6381:6381"
      - "26380:26380"
    network_mode: "host"
    depends_on:
      - redis-sentinel-1

  # Node 3: Replica + Sentinel
  redis-sentinel-3:
    image: "redis:7-alpine"
    container_name: redis-sentinel-3
    command: >
      sh -c "
      redis-server --port 6382 --bind 0.0.0.0 --replicaof 127.0.0.1 6380 --replica-announce-ip 127.0.0.1 &
      sleep 2 &&
      echo 'port 26381' > /tmp/sentinel.conf &&
      echo 'bind 0.0.0.0' >> /tmp/sentinel.conf &&
      echo 'sentinel announce-ip 127.0.0.1' >> /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster 127.0.0.1 6380 2' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "6382:6382"
      - "26381:26381"
    network_mode: "host"
    depends_on:
      - redis-sentinel-1

  opal-server:
    # by default we run opal-server from latest official image
    image: hub.comcast.net/dhapigw/opal-server:latest
    container_name: opal-server
    environment:
      # OPAL Server with Redis Sentinel for broadcast channel      
      - OPAL_BROADCAST_URI=redis+sentinel://127.0.0.1:26379,127.0.0.1:26380,127.0.0.1:26381/mymaster
      # Server Log configuration
      - OPAL_LOG_LEVEL=INFO
      - OPAL_LOG_FORMAT_INCLUDE_PID=true
      # number of uvicorn workers to run inside the opal-server container
      - UVICORN_NUM_WORKERS=1
      # Policy repo configuration (see if it can be removed, since we are using scopes)      
      - OPAL_POLICY_REPO_URL=https://github.com/permitio/opal-example-policy-repo
      # Policy repo polling interval (should probably change to a webhook approach in real deployments)
      - OPAL_POLICY_REPO_POLLING_INTERVAL=30
      # Data sources: authz rules and JWKS from well-known endpoint
      - OPAL_DATA_CONFIG_SOURCES={"config":{"entries":[{"url":"file:///data/authz.json","topics":["policy_data"],"dst_path":"/rules","periodic_update_interval":60},{"url":"https://your-auth-server.com/.well-known/jwks.json","topics":["policy_data"],"dst_path":"/shared/jwks","periodic_update_interval":3600}]}}
      
    ports:
      # exposes opal server on the host machine, you can access the server at: http://localhost:7002
      - "7002:7002"
    network_mode: "host"
    depends_on:
      - redis-sentinel-1
      - redis-sentinel-2
      - redis-sentinel-3

  opal-client-smesh-app1:
    # by default we run opal-client from latest official image
    image: hub.comcast.net/dhapigw/opal-client:latest
    container_name: opal-client-smesh-app1
    environment:
      # Server connection
      - OPAL_SERVER_URL=http://127.0.0.1:7002
      # Client Scope ID
      # Client Log configuration
      - OPAL_LOG_FORMAT_INCLUDE_PID=true
      - OPAL_LOG_LEVEL=DEBUG
      # Enable Data Updater
      - OPAL_DATA_UPDATER_ENABLED=true
      - UVICORN_PORT=7766
    ports:
      - "7766:7766"
      - "8181:8181"
    network_mode: "host"
    depends_on:
      - opal-server
    # Wait for server, register scope, then start client
    command: >
      sh -c "
      ./wait-for.sh 127.0.0.1:7002 --timeout=20 &&
      exec ./start.sh
      "
    # Mount data files into the container
    volumes:
      - ./data/app1:/data:ro
